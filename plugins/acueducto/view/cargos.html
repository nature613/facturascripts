{include="header"}

<script type="text/javascript">
   var conceptos = [
      {loop="$fsc->concepto->all()"}
      ['{$value->idconcepto}', '{$value->precio}'],
      {/loop}
   ];
   function recalculo()
   {
      conceptos.forEach(function(value) {
         if( value[0] == $("#conceptos").val() )
         {
            $("#precio").val( value[1] );
            $("#total").val( value[1] * parseFloat( $("#cantidad").val() ) );
         }
      });
   }
   
   function recalculo_linea(num)
   {
      conceptos.forEach(function(value) {
         if( value[0] == $("#conceptos_"+num).val() )
         {
            $("#precio_"+num).val( value[1] );
            $("#total_"+num).val( value[1] * parseFloat( $("#cantidad_"+num).val() ) );
         }
      });
   }
   
   $(document).ready(function() {
      recalculo();
   });
</script>

<div class="table-responsive">
    <table class="table table-condensed">
        <thead>
            <tr>
                <th class="text-left">Identificador</th>
                <th class="text-left" width="120">Cliente</th>
                <th class="text-left" width="120">Contador</th>
                <th class="text-left" width="250">Concepto</th>
                <th class="text-right">Precio</th>
                <th class="text-right">Cantidad</th>
                <th class="text-right">Total</th>
                <th class="text-left" width="120">Fecha</th>
                <th class="text-left">Facturado</th>
                <th class="text-right">Numero</th>
                <th class="text-left" width="120">Imputaci√≥n</th>
                <th class="text-left">Usuario</th>
                <th class="text-right" width="120">Acciones</th>
            </tr>
        </thead>
        <tbody>
            
         {if condition="$fsc->query==''"}
         <form action="{$fsc->url()}" method="post" class="form">
            <tr class="bg-info">
               <td>
                  <div class="form-control">Nuevo</div>
               </td>
              <td>
                  <select name="codcliente" class="form-control">
                     {loop="$fsc->cliente->all_full()"}
                     <option value="{$value->codcliente}">{$value->nombre}</option>
                     {/loop}
                  </select>
               </td>
               <td>
                  <select class="form-control" name="idcontador">
                     {loop="$fsc->contador->all()"}
                     <option value="{$value->idcontador}">{$value->numero}</option>
                     {/loop}
                  </select>
               </td>
               <td>
                  <select class="form-control" name="idconcepto" id="conceptos" onchange="recalculo()">
                     {loop="$fsc->concepto->all()"}
                     <option value="{$value->idconcepto}">{$value->descripcion}</option>
                     {/loop}
                  </select>
               </td>
               <td>
                  <input class="form-control text-right" type="text" name="precio" id="precio" value="{$fsc->show_numero(0)}" onchange="recalculo()" onkeyup="recalculo()" onclick="this.select()" />
               </td>
               <td>
                  <input class="form-control text-right" type="number" name="cantidad" id="cantidad" value="1" onchange="recalculo()" onkeyup="recalculo()" onclick="this.select()" />
               </td>
               <td>
                  <input class="form-control text-right" type="number" name="total" id="total" value="1" onchange="recalculo()" onkeyup="recalculo()" onclick="this.select()" />
               </td>
               <td>
                  <input class="form-control datepicker text-center" type="text" name="fecha" autocomplete="off" value="{$fsc->today()}"/>
               </td>
               <td>
                  <input class="checkbox-inline" type="checkbox" name="facturado" value="0" readonly/>
               </td>
               <td>
                  <input class="form-control text-right" type="number" name="numero" value="0" readonly/>
               </td>
               <td>
                  <input class="form-control" type="text" name="imputacion" autocomplete="off" value="{$fsc->today()}" readonly/>
               </td>
               <td>
                   <input class="form-control" type="text" name="usuario" autocomplete="off" value="{$fsc->user->nick}" readonly/>
               </td>
               <td class="text-right">
                  <button class="btn btn-sm btn-primary" type="submit" onclick="this.disabled=true; this.form.submit();" title="Guardar">
                     <span class="glyphicon glyphicon-floppy-disk"></span>
                  </button>
               </td>
            </tr>
         </form>
        {/if}   
         
         {loop="$fsc->listar_cargos()"}
         <form action="{$fsc->url()}" method="post" class="form">
            <input type="hidden" name="idcargo" value="{$value->idcargo}"/> 
            <tr>
                <td> 
                    <div class="form-control">{$value->idcargo}</div>
                </td>
                <td>
                    <select class="form-control" name="codcliente">
                    {loop="$fsc->cliente->all_full()"}
                       {if condition="$value2->codcliente == $value1->codcliente"}
                       <option value="{$value2->codcliente}" selected="selected">{$value2->nombre}</option>
                       {else}
                       <option value="{$value2->codcliente}">{$value2->nombre}</option>
                       {/if}
                    {/loop}
                    </select>
                </td>
                <td>
                    <select class="form-control" name="idcontador">
                    {loop="$fsc->contador->all()"}
                       {if condition="$value2->idcontador == $value1->idcontador"}
                       <option value="{$value2->idcontador}" selected="selected">{$value2->numero}</option>
                       {else}
                       <option value="{$value2->idcontador}">{$value2->numero}</option>
                       {/if}
                    {/loop}
                    </select>
                </td>
                <td>
                    <select class="form-control" name="idconcepto" id="conceptos_{$counter}" onchange="recalculo_linea('{$counter}')">
                    {loop="$fsc->concepto->all()"}
                       {if condition="$value2->idconcepto == $value1->idconcepto"}
                       <option value="{$value2->idconcepto}" selected="selected">{$value2->descripcion}</option>
                       {else}
                       <option value="{$value2->idconcepto}">{$value2->descripcion}</option>
                       {/if}
                    {/loop}
                    </select>
                </td>
                <td>
                    <input class="form-control text-right" type="text" step="any" name="precio" id="precio_{$counter}" value="{$fsc->show_numero($value->precio)}" onchange="recalculo_linea('{$counter}')" onkeyup="recalculo_linea('{$counter}')" onclick="this.select()" />
                </td>
                <td>
                    <input class="form-control text-right" type="number" name="cantidad" id="cantidad_{$counter}" value="{$value->cantidad}" onchange="recalculo_linea('{$counter}')" onkeyup="recalculo_linea('{$counter}')" onclick="this.select()" />
                </td>
                <td>
                    <input class="form-control text-right" type="number" name="total" id="total_{$counter}" value="{$value->total}" onchange="recalculo_linea('{$counter}')" onkeyup="recalculo_linea('{$counter}')" onclick="this.select()" />
                </td>
                <td>
                    <input class="form-control datepicker text-center" type="text" name="fecha" value="{$value->fecha}" size="10" autocomplete="off"/>
                </td>
                <td>
                    <input class="checkbox-inline" type="checkbox" name="facturado" value="{$value->facturado}" readonly/>
                </td>
                <td>
                    <input class="form-control text-right" type="number" name="numero" value="{$value->numero}" readonly/>
                </td>
                <td>
                    <input class="form-control datepicker text-center" type="text" name="imputacion" value="{$value->imputacion}" autocomplete="off"readonly/>
                </td>
                <td>
                    <input class="form-control" type="text" name="usuario" value="{$value->usuario}"  autocomplete="off" readonly/>
                </td>
                <td class="text-right">
                  <div class="btn-group">
                     <a class="btn btn-sm btn-danger" href="{$fsc->url()}&delete={$value->idcargo}" title="Eliminar">
                        <span class="glyphicon glyphicon-trash"></span>
                     </a>
                     <button class="btn btn-sm btn-primary" type="submit" onclick="this.disabled=true; this.form.submit();" title="Guardar">
                        <span class="glyphicon glyphicon-floppy-disk"></span>
                     </button>
                  </div>
               </td>
            </tr>
         </form>  
         {else}
          <tr class="bg-warning">
            <td colspan="12">Sin resultados</td>
         </tr>
         {/loop}
         
         
        </tbody>
    </table>
</div>

{include="footer"}