{% extends "Master/MenuTemplate.html" %}

{% block css %}
    {{ parent() }}
    
    <style type="text/css">
        .table th {
            border-top: none;
        }
    </style>
{% endblock %}

{% block javascript %}
{{ parent() }}
<script type="text/javascript">    
    $(document).ready(function () {
        // Aplica el tiempo de delay para los mensajes de ayuda
        $('[data-toggle="popover"]').popover({
            delay: { "show": 1000, "hide": 100 }
        });
        
        // Se situa en el tab, si lo solicitan en la url
        if(window.location.hash) {
            $('#mainTabs a[href="'+window.location.hash+'"]').tab('show');
        }
        
        // Situa el foco cuando se cambia de tab
        $('#mainTabs').on('shown.bs.tab', function (e) {
            self.setFormFocus(selectedTab());
        });
        
        // Situa el foco al cargar la página
        var index = selectedTab();
        self.setFormFocus(index);
    });

    // Situa el foco sobre el campo de búsqueda del tab indicado
    function setFormFocus(index) {
        var formName = '#form_search' + index + ' :text:first';
        $(formName).focus().select();
    }
    
    // Devuelve cual es el tab seleccionado
    function selectedTab() {
        return $('#mainTabContent > div.tab-pane.active').data('tabindex');
    }

    // Calcula el controlador a llamar para insertar registros
    function insertRecord() {
        var url = [{{ fsc.getStringURLs('new')|raw }}];
        var index = selectedTab();
        document.insert_form.action = url[index];
        document.insert_form.submit(); 
    }    
</script>
{% endblock %}

{% block messages %}
<div class="container-fluid">
    <div id="messages" class="row">
        <div class="col-12">            
            {{ parent() }}
        </div>
    </div>
</div>
{% endblock %}

{% block body %}
<!-- Calculate texts according to language -->
{% set refresh = i18n.trans('Refrescar la página') %}
{% set defaultT, defaultF = i18n.trans('marcar como página de inicio'), i18n.trans('Marcada como página de inicio (pulsa de nuevo para desmarcar)') %}
{% set options, options_title = i18n.trans('Opciones'), i18n.trans('Opciones de configuración') %}
{% set print, print_title = i18n.trans('Imprimir'), i18n.trans('Imprimir lista de registros') %}
{% set new_record, new_record_title = i18n.trans('Nuevo'), i18n.trans('Crear un nuevo registro') %}
{% set search_title = i18n.trans('Filtra los registros que contienen el valor indicado') %}
{% set any = i18n.trans('Cualquier') %}
{% set panel_header = i18n.trans('Datos generales') %}
{% set title = fsc.getPageData()['title'] %}
{% set title = i18n.trans(title) %}
{% set no_data = i18n.trans('No hay registros con esas condiciones. Pulse el botón Nuevo para dar de alta.') %}

<!-- Calculate common values -->
{% set list_url = fsc.views[0].getURL('list') %}

<!-- Macros Template Imports -->
{% from 'Macro/Utils.html' import popoverTitle as popoverTitle %}
{% from 'Macro/Utils.html' import message as show_message %}

<!-- Page Header -->
<div class="container-fluid d-print-none">
 {{ parent() }}
 
    <!-- Header Row -->
    <div class="row">
        <div class="col-sm-7 col-6">
            <div class="btn-group hidden-xs">
                <a class="btn btn-sm btn-light" href="{{ list_url }}" {{ popoverTitle(refresh, 'bottom') }}>
                    <i class="fa fa-refresh" aria-hidden="true"></i>
                </a>
                {% if fsc.getPageData()['isDefault'] %}
                <a class="btn btn-sm btn-light active" href="{{ list_url }}&amp;default_page=FALSE" {{ popoverTitle(defaultF, 'bottom') }}>
                    <i class="fa fa-bookmark" aria-hidden="true"></i>
                </a>
                {% else %}
                <a class="btn btn-sm btn-light" href="{{ list_url }}&amp;default_page=TRUE" {{ popoverTitle(defaultT, 'bottom') }}>
                    <i class="fa fa-bookmark-o" aria-hidden="true"></i>
                </a>
                {% endif %}
            </div>
            <div class="btn-group">
                <form action="#" method=post name="insert_form">
                    <input type="hidden" name="action" value="insert"> 
                </form>             
                
                <a id="b_new_record" class="btn btn-sm btn-success" onclick="insertRecord();" href="#" {{ popoverTitle(new_record_title, 'bottom') }}>
                    <i class="fa fa-plus" aria-hidden="true"></i>
                    <span class="hidden-xs">&nbsp;{{ new_record }}</span>
                </a>
                                
                <a href="#" id="b_options" class="btn btn-sm btn-secondary" {{ popoverTitle(options_title, 'bottom') }}>
                    <i class="fa fa-wrench" aria-hidden="true"></i>
                    <span class="hidden-xs">&nbsp;{{ options }}</span>
                </a>
                
                <a href="#" id="b_print" class="btn btn-sm btn-secondary" onclick="window.print();" {{ popoverTitle(print_title, 'bottom') }}>
                    <i class="fa fa-print" aria-hidden="true"></i>
                    <span class="hidden-xs">&nbsp;{{ print }}</span>
                </a>
                {#    TODO: Aplicar extensiones
                {% for value in fsc.extensions %}
                {% if value.type == 'button' %}
                <a href="index.php?page={{ value.from }}{{ value.params }}" class="btn btn-sm btn-light">{{ value.text }}</a>
                {% endif %}
                {% endfor %}
                #}
            </div>
        </div>
        <div class="col-sm-5 col-6 text-right">
            <h2 style="margin-top: 0px;">
                <i class="fa {{ fsc.getPageData()['icon'] }}" aria-hidden="true"></i> {{ title }}
            </h2>
        </div>
    </div>
</div>

<!-- Main Data -->
<div id="tab_options" role="tabpanel">
    <!-- Tabs declaration -->
    <ul class="nav nav-tabs d-print-none" id="mainTabs" role="tablist">
        {% for view in fsc.views %}
        {% set indexView = loop.index - 1 %}
        <li class="nav-item">
            {% set active = (indexView == fsc.active) ? 'active' : '' %}
            <a href="#{{ view.getModelID() }}" class="nav-link {{ active }}" id="{{ view.getModelID() }}-tab" onclick="setFormFocus({{ indexView }});"
               data-toggle="tab" role="tab" 
               aria-controls="{{ view.getModelID() }}" aria-expanded="true">
                <i class="fa fa-search" aria-hidden="true"></i>
                <span class="hidden-xs">&nbsp;{{ i18n.trans(view.title) }}</span>
                <span class="badge badge-secondary">{{ view.count }}</span>
            </a>
        </li>
        {% endfor %}
        
        {#    TODO: Aplicar extensiones
        {% for value in fsc.extensions %}
        {% if value.type == 'tab' %}
        <li class="nav-item">
            <a href="#ext_{{ value.name }}" aria-controls="ext_{{ value.name }}" role="tab" data-toggle="tab">{{ value.text }}</a>
        </li>
        {% endif %}
        {% endfor %}
        #}
    </ul>

    <!-- Main Tab -->
    <div class="tab-content" id="mainTabContent">
        {% for view in fsc.views %}        
        {% set indexView = loop.index - 1 %}
        {% set active = (indexView == fsc.active) ? 'active' : '' %}
        <div class="tab-pane {{ active }}" id="{{ view.getModelID() }}" role="tabpanel" aria-labelledby="{{ view.getModelID() }}-tab" data-tabindex="{{ indexView }}">
            <!-- Filters Row -->
            <form name="f_custom_search{{ indexView }}" id="form_search{{ indexView }}" action="{{ list_url }}" method="post" class="form">
                <div class="container-fluid d-print-none" style="margin-top: 15px; margin-bottom: 10px;">
                    <div class="row">
                        <!-- Main filter -->
                        <div class="col-md-2">
                            <div class="input-group">
                                <input type="hidden" name="active" value="{{ indexView }}"> 
                                <input class="form-control" type="text" name="query" id="query{{ indexView }}" value="{% if indexView == fsc.active %}{{ fsc.query }}{% endif %}" autocomplete="off" placeholder="Buscar">
                                <span class="input-group-btn hidden-sm">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fa fa-search" aria-hidden="true"></i>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <!-- Aditionals filters -->
                        {% for key1, filter in view.getFilters() %}
                        {% if filter.type == 'select' %}
                        <div class="col-2">
                            <select name="{{ key1 }}" class="form-control" onchange="this.form.submit()">
                                <option value="">{{ any }} {{ key1 }}</option>
                                <option value="">------</option>
                                {% for key2, data in fsc.optionlist(key1, filter.options) %}
                                {% if (indexView == fsc.active) and (data == filter.value) %}
                                <option value="{{ key2 }}" selected="">{{ data }}</option>
                                {% else %}
                                <option value="{{ key2 }}">{{ data }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        {% if filter.type == 'checkbox' %}
                        <div class="col">
                            <div class="checkbox-inline">
                                <label>
                                    {% if (indexView == fsc.active) and filter.value %}
                                    <input type="checkbox" name="{{ key1 }}" value="TRUE" checked="" onchange="this.form.submit()"/>
                                    {% else %}
                                    <input type="checkbox" name="{{ key1 }}" value="TRUE" onchange="this.form.submit()"/>
                                    {% endif %}
                                    {{ filter.options.label }}
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        {% if filter.type == 'datepicker' %}
                        <div class="col">
                            <input type="text" name="{{ key1 }}" value="{% if indexView == fsc.active %}{{ filter.value }}{% endif %}" class="form-control datepicker"
                                   placeholder="{{ filter.options.label }}" autocomplete="off" onchange="this.form.submit()"/>                            
                        </div>
                        {% endif %}                        
                        {% endfor %}

                        <!-- Order by selector -->
                        <div class="col">
                            <div class="btn-group float-md-right">
                                {% set orderbylist = view.getOrderBy() %}
                                <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuOrder{{ indexView }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <i class="fa {{ orderbylist[view.selectedOrderBy]['icon'] }}" aria-hidden="true"></i>
                                    &nbsp; {{ i18n.trans(orderbylist[view.selectedOrderBy]['label']) }}
                                    <span class="caret"></span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuOrder{{ indexView }}">
                                    {% for key, orderby in orderbylist %}
                                    <a class="dropdown-item" href="{{ list_url }}&order={{ key }}">
                                        <i class="fa {{ orderby['icon'] }}" aria-hidden="true"></i>&nbsp; {{ i18n.trans(orderby['label']) }} &nbsp;
                                        {% if view.selectedOrderBy == key %}
                                        <i class="fa fa-check" aria-hidden="true"></i>
                                        {% endif %}
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Data Row -->
            <div class="table-responsive">
                <!-- Data Table -->
                <table class="table table-hover">
                    <thead>
                        <tr>
                            {% for column in view.getColumns() %}
                            {% if column.display != 'none' %}
                            <th class="text-{{ column.display }}">{{ column.getHeaderHTML(column.title)|raw }}</th>
                            {% endif %}
                            {% endfor %}
                        </tr>
                    </thead>
                    {% for data in view.getCursor() %}
                    {% set row = view.getRow('status') %}
                    {% if row is empty %}
                    <tr class="table-light">
                    {% else %}
                    {% set status = attribute(data, row.fieldName) %}
                    <tr class="{{ row.getStatus(status) }}">
                    {% endif %}
                        {% for column in view.getColumns() %}
                        {% if column.display != 'none' %}
                        {% set value = attribute(data, column.widget.fieldName) %}
                        <td class="text-{{ column.display }}">{{ column.getListHTML(value)|raw }}</td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% else %}
                    <tr class="table-warning">
                        <td colspan="12"><b>{{ no_data }}</b></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- Footer Navigation -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12 text-center">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                            {% for item in fsc.pagination(indexView) %}
                                {% if item.active %}
                                <li class="page-item active">
                                    <span class="page-link">{{ item.page }}<span class="sr-only">(current)</span></span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ item.url }}">
                                        {% if item.icon %}
                                        <i class="fa {{ item.icon }}" aria-hidden="true"></i>
                                        {% else %}
                                        <span>{{ item.page }}</span>
                                        {% endif %}
                                    </a>
                                </li>    
                                {% endif %}
                            {% endfor %}
                            </ul>
                        </nav>
                        <br/>
                        <br/>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Aditionals Tabs -->
        {#  TODO: Aplicar extensiones
        {% for extension in fsc.extensions %}
        {% if extension.type == 'tab' %}
        <div role="tabpanel" class="tab-panel" id="ext_{{ extension.name }}">
            <iframe src="index.php?page={{ extension.from }}{{ extension.params }}"
                    width="100%" height="2000" frameborder="0"></iframe>
        </div>
        {% endif %}
        {% endfor %}
        #}
    </div>
</div>
{% endblock %}