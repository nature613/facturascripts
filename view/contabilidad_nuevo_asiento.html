{include="header"}

<script type="text/javascript">
   var numlineas = 0;
   function add_partida()
   {
      numlineas++;
      $("#partidas").append("<div class=\"rounded\">\n\
         <div>\n\
            <input type=\"hidden\" id=\"idsubcuenta_"+numlineas+"\" name=\"idsubcuenta_"+numlineas+"\"/>\n\
            Subcuenta:\n\
            <input id=\"codsubcuenta_"+numlineas+"\" name=\"codsubcuenta_"+numlineas+"\" type=\"text\" size=\"10\"\n\
               onclick=\"show_buscar_subcuentas('"+numlineas+"','subcuenta')\" autocomplete=\"off\"/>\n\
            <input type=\"text\" id=\"dessubcuenta_"+numlineas+"\" name=\"dessubcuenta_"+numlineas+"\" size=\"60\" disabled=\"disabled\"/>\n\
            saldo: <input type=\"text\" id=\"saldo_"+numlineas+"\" name=\"saldo_"+numlineas+"\" value=\"0\" size=\"8\"\n\
                disabled=\"disabled\"/>\n\
         </div>\n\
         <div id=\"datos_partida_"+numlineas+"\" class=\"hidden\">\n\
         <div>\n\
            debe: <input type=\"text\" id=\"debe_"+numlineas+"\" name=\"debe_"+numlineas+"\" value=\"0\" size=\"6\"\n\
               onclick=\"this-select()\" onkeyup=\"recalcular()\" autocomplete=\"off\"/>\n\
            haber: <input type=\"text\" id=\"haber_"+numlineas+"\" name=\"haber_"+numlineas+"\" size=\"6\" value=\"0\"\n\
               onclick=\"this-select()\" onkeyup=\"recalcular()\" autocomplete=\"off\"/>\n\
            <input type=\"button\" value=\"limpiar\" onclick=\"clean_partida('"+numlineas+"')\"/>\n\
         </div>\n\
         <div>\n\
            <input type=\"hidden\" id=\"idcontrapartida_"+numlineas+"\" name=\"idcontrapartida_"+numlineas+"\"/>\n\
            Contrapartida:\n\
            <input id=\"codcontrapartida_"+numlineas+"\" name=\"codcontrapartida_"+numlineas+"\" type=\"text\" size=\"10\"\n\
               onclick=\"show_buscar_subcuentas('"+numlineas+"','contrapartida')\" autocomplete=\"off\"/>\n\
            <input type=\"text\" id=\"descontrapartida_"+numlineas+"\" name=\"descontrapartida_"+numlineas+"\" size=\"60\" disabled=\"disabled\"/>\n\
            saldo: <input type=\"text\" id=\"saldoc_"+numlineas+"\" name=\"saldoc_"+numlineas+"\" value=\"0\" size=\"8\"\n\
                disabled=\"disabled\"/>\n\
         </div>\n\
         <div id=\"datos_contrapartida_"+numlineas+"\" class=\"hidden\">\n\
            cif/nif: <input type=\"text\" id=\"cifnif_"+numlineas+"\" name=\"cifnif_"+numlineas+"\" size=\"10\"/>\n\
            IVA: <select id=\"iva_"+numlineas+"\" name=\"iva_"+numlineas+"\" onchange=\"recalcular()\">\n\
            {loop="$fsc->impuesto->all()"}<option value=\"{$value->iva}\">{$value->descripcion}</option>{/loop}\n\
            </select>\n\
            Base imponible: <input type=\"text\" id=\"baseimp_"+numlineas+"\" name=\"baseimp_"+numlineas+"\" value=\"0\" size=\"6\"\n\
               autocomplete=\"off\"/>\n\
         </div>\n\
         </div>\n\
         </div>");
   }
   function show_buscar_subcuentas(num, tipo)
   {
      $("#subcuentas").html('');
      document.f_buscar_subcuentas.ejercicio.value = document.f_asiento.codejercicio.options[document.f_asiento.codejercicio.selectedIndex].value;
      document.f_buscar_subcuentas.tipo.value = tipo;
      document.f_buscar_subcuentas.numlinea.value = num;
      document.f_buscar_subcuentas.query.value = '';
      fs_show_popup('popup_subcuentas', 40);
      document.f_buscar_subcuentas.query.focus();
   }
   function buscar_subcuentas()
   {
      if(document.f_buscar_subcuentas.query.value == '')
      {
         $("#subcuentas").html('');
         $("#popup_subcuentas").css({
            left: ($(window).width() - $("#popup_subcuentas").outerWidth())/2,
            top: 40
         });
      }
      else
      {
         var datos = 'query='+document.f_buscar_subcuentas.query.value;
         datos += "&tipo="+document.f_buscar_subcuentas.tipo.value;
         datos += "&ejercicio="+document.f_buscar_subcuentas.ejercicio.value;
         $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            dataType: 'html',
            data: datos,
            success: function(datos) {
               var re = /<!--(.*?)-->/g;
               var m = re.exec( datos );
               if( m[1] == document.f_buscar_subcuentas.query.value )
               {
                  $("#subcuentas").html(datos);
                  $("#popup_subcuentas").css({
                     left: ($(window).width() - $("#popup_subcuentas").outerWidth())/2,
                     top: 40
                  });
               }
            }
         });
      }
   }
   function select_subcuenta(idsubcuenta, codsubcuenta, descripcion, saldo)
   {
      var num = document.f_buscar_subcuentas.numlinea.value;
      if(document.f_buscar_subcuentas.tipo.value == 'subcuenta')
      {
         $("#idsubcuenta_"+num).val(idsubcuenta);
         $("#codsubcuenta_"+num).val(codsubcuenta);
         $("#dessubcuenta_"+num).val(descripcion);
         $("#saldo_"+num).val(saldo);
         $("#datos_partida_"+num).show();
      }
      else
      {
         $("#idcontrapartida_"+num).val(idsubcuenta);
         $("#codcontrapartida_"+num).val(codsubcuenta);
         $("#descontrapartida_"+num).val(descripcion);
         $("#saldoc_"+num).val(saldo);
         $("#datos_contrapartida_"+num).show();
      }
      fs_hide_popups();
   }
   function clean_partida(num)
   {
      $("#idsubcuenta_"+num).val('');
      $("#codsubcuenta_"+num).val('');
      $("#dessubcuenta_"+num).val('');
      $("#saldo_"+num).val('0');
      $("#debe_"+num).val('0');
      $("#haber_"+num).val('0');
      $("#idcontrapartida_"+num).val('');
      $("#codcontrapartida_"+num).val('');
      $("#descontrapartida_"+num).val('');
      $("#saldoc_"+num).val('0');
      $("#cifnif_"+num).val('');
      $("#baseimp_"+num).val('0');
      $("#datos_contrapartida_"+num).hide();
      $("#datos_partida_"+num).hide();
   }
   function recalcular()
   {
      var debe = 0;
      var haber = 0;
      for(var i=1; i<=numlineas; i++)
      {
         if( !isNaN( $("#idcontrapartida_"+i).val() ) )
         {
            var iva = parseFloat( $("#iva_"+i).val() );
            if(iva == 0)
               $("#baseimp_"+i).val('0');
            else
            {
               if( parseFloat( $("#debe_"+i).val() ) > 0 )
                  $("#baseimp_"+i).val( parseFloat($("#debe_"+i).val())*100/iva );
               else if( parseFloat( $("#haber_"+i).val() ) > 0 )
                  $("#baseimp_"+i).val( parseFloat($("#haber_"+i).val())*100/iva );
               else
                  $("#baseimp_"+i).val(0);
            }
         }
         
         if( parseFloat( $("#debe_"+i).val() ) > 0 )
            debe += parseFloat( $("#debe_"+i).val() );
         else if( parseFloat( $("#haber_"+i).val() ) > 0 )
            haber += parseFloat( $("#haber_"+i).val() );
      }
      document.f_asiento.importe.value = Math.max(debe,haber);
      document.f_asiento.descuadre.value = debe - haber;
   }
   function asigna_concepto()
   {
      document.f_asiento.concepto.value = document.f_asiento.idconceptopar.options[document.f_asiento.idconceptopar.selectedIndex].text;
   }
   $(document).ready(function() {
      $("#f_buscar_subcuentas").keyup(function() {
         buscar_subcuentas();
      });
      $("#f_buscar_subcuentas").submit(function(event) {
         event.preventDefault();
         buscar_subcuentas();
      });
      $("#f_asiento").submit(function(event) {
         event.preventDefault();
         document.f_asiento.numlineas.value = numlineas;
         document.f_asiento.importe.disabled = false;
         document.f_asiento.submit();
      });
   });
</script>

<form id="f_asiento" name="f_asiento" action="{$fsc->url()}" method="post">
   <input type="hidden" name="numlineas" value="0"/>
   <div class="rounded">
      <div class="bloque">
         <a href="{$fsc->ejercicio->url()}">Ejercicio</a>:
         <select name="codejercicio">
            {loop="$fsc->ejercicio->all_abiertos()"}
               {if condition="$value->is_default()"}
               <option value="{$value->codejercicio}" selected="selected">{$value->nombre}</option>
               {else}
               <option value="{$value->codejercicio}">{$value->nombre}</option>
               {/if}
            {/loop}
         </select>
      </div>
      <div class="bloque">
         Fecha: <input class="tcal" name="fecha" type="text" value="{$fsc->asiento->fecha}" size="10"/>
      </div>
      <div class="bloque">
         ID concepto:
         <select name="idconceptopar" onchange="asigna_concepto()">
            <option value="">---</option>
            {loop="$fsc->concepto->all()"}
            <option value="{$value->idconceptopar}">{$value->concepto}</option>
            {/loop}
         </select>
         Concepto: <input name="concepto" type="text" size="30"/>
      </div>
      <div class="bloque">
         Documento: <input name="documento" type="text" size="30"/>
         Tipo documento:
         <select name="tipodocumento">
            <option value="">---</option>
            <option value="Recibo">Recibo</option>
            <option value="Factura de cliente">Factura de cliente</option>
            <option value="Factura de proveedor">Factura de proveedor</option>
         </select>
      </div>
      <table class="list">
         <tr>
            <td>
               Divisa:
               <select name='divisa'>
                  {loop="$fsc->divisa->all()"}
                     {if condition="$value->is_default()"}
                        <option value='{$value->coddivisa}' selected='selected'>{$value->descripcion}</option>
                     {else}
                        <option value='{$value->coddivisa}'>{$value->descripcion}</option>
                     {/if}
                  {/loop}
               </select>
            </td>
            <td align="right">
               Importe:
               <input type="text" name="importe" value="0" size="6" disabled="disabled"/>
               Descuadre:
               <input type="text" name="descuadre" value="0" size="6" disabled="disabled"/>
               <input type="submit" value="guardar"/>
            </td>
         </tr>
      </table>
   </div>
   <div id="partidas"></div>
   <div class="rounded">
      <div class="new_line">
         <a href="#" onclick="add_partida(); return false;">Añadir partida...</a>
      </div>
   </div>
</form>

<div class="popup" id="popup_subcuentas" style="min-width: 60%">
   <form id="f_buscar_subcuentas" name="f_buscar_subcuentas">
      <input type="hidden" name="ejercicio"/>
      <input type="hidden" name="tipo"/>
      <input type="hidden" name="numlinea"/>
      <h1>Buscar subcuentas</h1>
      <div style="text-align: center;">
         <input type="text" name="query" size="40"/>
         <input type="submit" value="buscar"/>
      </div>
   </form>
   <div id="subcuentas"></div>
</div>

{include="footer"}